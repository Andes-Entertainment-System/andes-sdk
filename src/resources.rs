use std::{
    collections::HashMap,
    fs::File,
    io::{BufWriter, Write},
    path::{Path, PathBuf},
};

use anyhow::Context;
use serde::{Deserialize, Serialize};

pub mod audio;
pub mod palette;
pub mod rawdata;
pub mod spriteset;
pub mod tilemap;
pub mod tileset;

#[derive(Serialize, Deserialize)]
pub struct ResourceConfig {
    #[serde(default)]
    audio: Vec<audio::AudioDef>,
    #[serde(default)]
    palettes: Vec<palette::PaletteDef>,
    #[serde(default)]
    rawdata: Vec<rawdata::RawDataDef>,
    #[serde(default)]
    spritesets: Vec<spriteset::SpriteSetDef>,
    #[serde(default)]
    tilesets: Vec<tileset::TileSetDef>,
    #[serde(default)]
    tilemaps: Vec<tilemap::TileMapDef>,
}

pub struct ResCompilerArgs<'a> {
    resources_path: PathBuf,
    res_config: ResourceConfig,
    build_buffer: &'a mut BufWriter<File>,
    header_buffer: BufWriter<File>,
    source_buffer: BufWriter<File>,
    resolved: ResolvedResources,
}
pub struct ResolvedResources {
    tilesets: HashMap<String, tileset::ResolvedTileSet>,
}

impl Default for ResolvedResources {
    fn default() -> ResolvedResources {
        ResolvedResources {
            tilesets: HashMap::new(),
        }
    }
}

pub fn compile(project_path: &Path, build_buffer: &mut BufWriter<File>) -> anyhow::Result<()> {
    println!("Compiling resources...");

    let resources_path = project_path.join("resources");

    let res_config_file = File::open(resources_path.join("resources.yml"))
        .context("Failed to load resources config file.")?;
    let res_config: ResourceConfig = serde_yml::from_reader(res_config_file)?;

    let header_file = File::create(resources_path.join("andes_resources.h"))?;
    let source_file = File::create(resources_path.join("andes_resources.c"))?;

    let mut compiler_args = ResCompilerArgs {
        resources_path,
        res_config,
        build_buffer,
        header_buffer: BufWriter::new(header_file),
        source_buffer: BufWriter::new(source_file),
        resolved: ResolvedResources::default(),
    };

    compiler_args
        .header_buffer
        .write_all(b"// AUTOMATICALLY GENERATED BY ANDES SDK. MODIFYING NOT RECOMMENDED.\n\n")?;
    compiler_args
        .source_buffer
        .write_all(b"// AUTOMATICALLY GENERATED BY ANDES SDK. MODIFYING NOT RECOMMENDED.\n\n")?;

    compiler_args
        .header_buffer
        .write_all(b"#pragma once\n\n#include <andes_res_types.h>\n\n")?;
    compiler_args
        .source_buffer
        .write_all(b"#include <andes_resources.h>\n\n")?;

    audio::compile(&mut compiler_args)?;
    palette::compile(&mut compiler_args)?;
    rawdata::compile(&mut compiler_args)?;
    spriteset::compile(&mut compiler_args)?;
    tileset::compile(&mut compiler_args)?;
    tilemap::compile(&mut compiler_args)?;

    Ok(())
}
